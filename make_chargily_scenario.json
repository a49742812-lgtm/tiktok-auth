{
  "name": "Chargily Payment -> Activate Subscription",
  "description": "Scaffolded Make scenario to import: webhook trigger (Chargily) -> Router -> Success path: update backend user/subscription, send email (SMTP), send WhatsApp (HTTP) -> Failure path: notify admin.",
  "version": "1.0",
  "variables": {
    "BACKEND_API_BASE": "https://your-backend.example.com",
    "SMTP_FROM": "no-reply@yourdomain.com",
    "WHATSAPP_API_URL": "https://api.ultramsg.com/messages",
    "WHATSAPP_API_TOKEN": "YOUR_WA_TOKEN"
  },
  "modules": [
    {
      "id": "webhook_1",
      "type": "webhook",
      "name": "Chargily Webhook (Custom)",
      "config": {
        "method": "POST",
        "url": "https://hook.make.com/your_unique_hook_here",
        "expected_payload_example": {
          "id": "pay_123",
          "amount": 1500,
          "currency": "DZD",
          "customer": {"email": "amine@test.com", "name": "Amine"},
          "payment_status": "paid",
          "metadata": {"accountId": "12345", "plan": "pro"}
        }
      }
    },
    {
      "id": "router_1",
      "type": "router",
      "name": "Router: success / failed",
      "config": {
        "routes": ["paid", "failed"]
      },
      "logic": "If payload.payment_status == 'paid' -> route 'paid' else 'failed'"
    },
    {
      "id": "http_to_backend_create",
      "type": "http",
      "name": "POST /api/users/create (Backend)",
      "config": {
        "method": "POST",
        "url": "{{BACKEND_API_BASE}}/api/users/create",
        "headers": {"Content-Type": "application/json"},
        "body_template": {
          "email": "{{payload.customer.email}}",
          "name": "{{payload.customer.name}}",
          "plan": "{{payload.metadata.plan}}",
          "status": "active",
          "charged_amount": "{{payload.amount}}",
          "currency": "{{payload.currency}}",
          "source": "chargily",
          "transaction_id": "{{payload.id}}"
        }
      }
    },
    {
      "id": "http_to_backend_update_subscription",
      "type": "http",
      "name": "POST /api/subscriptions/activate",
      "config": {
        "method": "POST",
        "url": "{{BACKEND_API_BASE}}/api/subscriptions/activate",
        "headers": {"Content-Type": "application/json"},
        "body_template": {
          "email": "{{payload.customer.email}}",
          "plan": "{{payload.metadata.plan}}",
          "transaction_id": "{{payload.id}}",
          "next_billing_date": "{{computed_next_billing}}"
        }
      }
    },
    {
      "id": "smtp_send",
      "type": "smtp",
      "name": "Send confirmation email (SMTP)",
      "config": {
        "from": "{{SMTP_FROM}}",
        "to": "{{payload.customer.email}}",
        "subject": "اشتراكك تم تفعيله - {{payload.metadata.plan}}",
        "body": "مرحبا {{payload.customer.name}},\n\nتم تأكيد الدفع بمبلغ {{payload.amount}} {{payload.currency}}. اشتراكك ({{payload.metadata.plan}}) مفعل الآن.\n\nرابط الدخول: https://yourdomain.com/login\n\nشكراً لك."
      }
    },
    {
      "id": "http_whatsapp",
      "type": "http",
      "name": "Send WhatsApp message (UltraMsg)",
      "config": {
        "method": "POST",
        "url": "{{WHATSAPP_API_URL}}",
        "headers": {"Content-Type": "application/json", "Authorization": "Bearer {{WHATSAPP_API_TOKEN}}"},
        "body_template": {
          "to": "{{payload.customer.phone || payload.customer.email}}",
          "body": "✔ تم تفعيل اشتراكك بنجاح! شكرا {{payload.customer.name}}. ادخل لتسجيل الدخول: https://yourdomain.com/login"
        }
      }
    },
    {
      "id": "notify_admin",
      "type": "http",
      "name": "Notify Admin (failed payments)",
      "config": {
        "method": "POST",
        "url": "{{BACKEND_API_BASE}}/api/notify/admin",
        "headers": {"Content-Type": "application/json"},
        "body_template": {
          "subject": "Failed payment for {{payload.customer.email}}",
          "payload": "{{payload}}"
        }
      }
    }
  ],
  "flows": {
    "paid": [
      "webhook_1 -> router_1 (paid) -> http_to_backend_create -> http_to_backend_update_subscription -> smtp_send -> http_whatsapp"
    ],
    "failed": [
      "webhook_1 -> router_1 (failed) -> notify_admin"
    ]
  },
  "notes": [
    "1) Replace hook URL with the one generated by Make when you create a Custom Webhook module.",
    "2) Use environment variables in Make for BACKEND_API_BASE, SMTP_FROM, WHATSAPP_API_URL, WHATSAPP_API_TOKEN.",
    "3) For subscriptions, backend should compute next_billing_date and store subscription record.",
    "4) Test using Chargily test payments and verify webhook payload format, adjust mappings accordingly."
  ]
}
